#I2c总线规范和使用说明
<br>
第六版 2014年4月4日
文件信息
关键词： I2C, I2C-bus, Standard-mode, Fast-mode, Fast-mode Plus, Fm+, Ultra Fast-mode, UFm, High Speed, Hs, inter-IC, SDA, SCL, USDA, USCL
<br>
摘要：Philips 半导体（现在是 NXP 半导体）开发了一个简单的双向2-线总线用于芯片互联高效控制。此总线称为 Inter-IC 或i2c总线。总线只需要两条信号线：一个串行数据线（SDA）和一个串行时钟线（SCL）。8位串行,双向的数据传输在标准模式下通信速度可以达到100 kbit/s，快速模式下可以达到400 kbit/s，在快速模式 Plus（Fm+）中最高可达1 Mbit/s，或在高速模式下最多可达3.4 Mbit/s。超快模式时数据单向传输，最多可达5 Mbit/s.
<br>
版本历史
第6版 2014年04月04日
第5版 2012年10月09日
第4版 2012年02月13日
第3版 2007年06月19日
第2.1版 2000年
第2版 1998年
第1版 1992年

##1 介绍
I2C-bus是一种事实上的世界标准,已经运用在50多家公司生产的超过1000多不同ICs上。此外，i2c总线还应用于各种控制体系结构中，如系统管理总线（SMBus），电源管理总线（PMBus），智能平台管理接口（IPMI），显示数据通道（DDC）和高级电信计算架构（ATCA）。
本文档帮助设备和系统设计人员了解i2c总线的工作原理并实现一个工作应用程序。描述了各种操作模式。它包含i2c总线数据传输、握手和总线仲裁方案的全面介绍。详细的章节描述了每一种操作模式下的i2c总线的时序和电气规范。
i2c兼容芯片的设计者应该使用这个文档作为参考，并确保这些新设备满足了本文档中指定的所有限制。设计包括I2C设备的系统应该检查这个文档并引用单独的组件数据表。
##2 I2C总线特性
在消费电子、电信和工业电子领域，看似毫不相关的设计往往有许多相似之处。例如，几乎每个系统都包括

 - 为了实现智能控制，通常使用单芯片的微控制器
 - 一些通用电路，如驱动LCD和LED，远程输入/输出端口，RAM，EEPROM，实时时钟或AD/DA转换器
 - 面向应用的电路，如用于无线电和视频系统，温度传感器和智能卡d 数字调谐和信号处理电路

为了利用这些相似之处，使系统设计者和设备制造商受益，同时也为了最大限度地提高硬件效率和电路的简单性，飞利浦半导体（现在的NXP半导体）开发了一种简单的双向2线总线，用于IC互联控制。该总线称为 Inter IC 或 I2C-bus。所有I2C-bus兼容设备都包含一个片上接口，允许它们通过i2c总线直接通信。这个设计概念解决了设计数字控制电路时遇到的许多接口问题。
以下是I2C总线的一些特性：

 - 只需要两条信号线;一个串行数据线（SDA）和一个串行时钟线（SCL）
 - 每个连接到总线的设备都是有一个唯一的地址。
任何时间总线只会存在简单的主/从关系（一段时期内只会有一个主机，其他全为从机）;master可以发起传输或接收数据
 - 它是一种真正的多主机总线，包括了碰撞检测和仲裁机制，以避免出现如果两个或两个以上的主同时启动数据传输时导致数据损坏。
 - 8位串行，双向的数据传输在标准模式下通信速度可以达到100 kbit/s，快速模式下可以达到400 kbit/s，在快速模式 Plus（Fm+）中最高可达1 Mbit/s，或在高速模式下最多可达3.4 Mbit/s。
 - 超快模式时数据单向传输，最多可达5 Mbit/s.
 - 在总线数据线上加入片上滤波器过滤尖峰，保持数据完整性。
 - 可以连接到同一总线的ICs的数量只受最大总线电容的限制。在某些情况下，可能放宽电容限制。参考 7.2章节
下图展示了I2C总线的典型应用。

###2.1 开发者受益
TODO:

###2.2 厂商受益
TODO:

###2.3 IC 设计者受益
TODO:

##3 I2C总线协议

###3.1 标准模式，快速模式，快速plus模式 I2C总线协议
两条线，串行数据（SDA）和串行时钟（SCL），在连接到总线的设备两者之间传递信息。每个设备都被一个唯一的地址识别（无论它是微控制器，LCD驱动，内存或是键盘接口），根据设备的功能，可以发射或接收数据。LCD模块可能只是一个接收器，而一个内存可以接收和发送数据。设备也可以扮演从设备或主设备执行数据传输（见表1）。主设备发起数据在总线上的传输并提供时钟信号，此时,被通信的设备是从设备。

术语     | 描述
-----    | ------
发送器   | 设备向总线发送数据
接收器   | 设备从总线接收数据
主设备   | 初始化传输，产生时钟信号，终止传输
从设备   | 被主设备寻址的设备
多主设备 | 多于一个可以同时控制总线且不丢失信息的主设备
同步     | 同步两个或多个设备的时钟信号的过程

I2C-bus是一种多主机总线。这意味着允许不止一个设备控制总线。主机通常是微控制器，需要考虑连接到i2c总线的两个微控制器之间的数据传输的情况

````
      MCU-A   ADC    EEPROM  LCD    MCU-B
       | |    | |    | |     | |     | |
SDA ___|_\____|_\____|_\_____|_\_____|_\______
SCL ___\______\______\_______\_______\________

````

这个例子描述了在I2C-总线上可能出现的主从和接收-发送关系。请注意，这种关系是变化的，设备的定位取决于当时数据传输的方向。数据的传输将按照以下方式进行：
1、假设MCU-A想要发送信息给MCU-B：

 - MCU-A（主机），MCU-B（从机）被寻址
 - MCU-A（主机发送），发起传输到MCU-B（从机接收）
 - MCU-A终止传输
 
2、 假设MCU-A想要接收来自MCU-B的信息：

 - MCU-A（主机），MCU-B（从机）被寻址
 - MCU-A（主机接收），发起传输到MCU-B（从机发送）
 - MCU-A终止传输

此时，MCU-A 产生时钟并终止传输。
将多个微控制器连接到i2c总线的情况意味着不止一个主机可以尝试同时启动数据传输。为了避免可能引发的混乱，需要一个仲裁程序。这个需要所有连接到I2C总线的I2C接口进行“线-与”联接。
如果两个或两个以上的主机尝试在总线上通信，第一个会产生一个“one”，另一种则产生“zero”失去仲裁。
仲裁期间的时钟信号是由主机产生的时钟的同步组合使用“线-与”连接到SCL信号线。（关于仲裁的更详细的信息请看3.1.8章节）
在i2c总线上生成时钟信号始终是主机的责任;
当在总线上传输数据时，每个主机都会生成自己的时钟信号。
只有当一个主机被一个缓慢的从装置拉低了时钟线，或者当仲裁发生时，主机的I2C总线时钟信号才会改变。
表2 总结了I2C总线系统特性的规范要求，包括了强制和可选部分
Table 2 i2c总线协议特性的要求
M = 强制; O = 可选; n/a = 不适用

| 特性  | 配置|||
|----|----|----|----|
||单总机|多总机 |从机|
|启动状态 | M | M | M |
|结束状态 | M | M | M |
|应答     | M | M | M |
|同步     |n/a| M |n/a|
|仲裁     |n/a| M |n/a|
|时钟展宽 | O | O | O |
|7位从地址| M | M | M |
|10位从地址|O | O | O |
|广播地址 | O | O | O |
|软件复位 | O | O | O |
|起始字节 |n/a| O |n/a|
|设备ID   |n/a|n/a| O |

###3.1.1 SDA和SCL信号
SDA和SCL都是双向信号线，通过电流源或上拉电阻连接到电源正极（见下图）。当总线空闲时，这两条线都为高电平。连接到总线的设备的输出部分必须是漏极开路或集电极开路保证“线-与”功能。
i2c总线上的数据传输速度在标准模式下，最高可达100 kbit/s，在快速模式下最多可达400 kbit/s
在快速plus模式下，1 Mbit/s，或在高速模式下最多可达3.4 Mbit/s。总线上的电容限制了连接到总线的接口的数量。
单主机的应用场景下，如果总线上没有从设备拉低时钟，那么主机的SCL输出可以使用推拉驱动设计。
![](leanote://file/getImage?fileId=5b617b0f6d935e3309000000)

###3.1.2 SDA和SCL逻辑电平
由于各种不同的技术设备（CMOS、NMOS、TTL）都可以连接到i2c总线，逻辑0（低）和1（高）的电平不是固定的，并且依赖于VDD的电平电压值。输入参考电压设置为VDD的30%和70%;VIL是0.3*VDD，VIH是0.7*VDD。请参见Figure 38，时序图。一些遗留设备的输入电平被固定在VIL=1.5 V和VIH=3.0 V，但是所有的新设备都需要遵循30%/70%的规格。参见Section 6 电气特性。

###3.1.3 数据有效性

SDA线的数据必须在时钟的高周期内保持稳定。当SCL线上的时钟是低电平时，数据线的高或低状态才可以发生变化（参见图4），每一个时钟脉冲传输一个数据位。
![](leanote://file/getImage?fileId=5b617d936d935e3309000001)

###3.1.4 开始和结束条件

所有的数据传输都以START（S）开头，并由STOP（P）终止（参见图5）。
SCL处于高电平，SDA线上的一个高到低的下降沿定义了开始条件
SCL处于高电平，SDA线上的一个低到高的上升沿定义了结束条件
![](leanote://file/getImage?fileId=5b617e716d935e3309000002)
启动和停止条件都是由主机控制的，总线在开始状态后被认为是忙碌的。在停止条件结束后的一段时间内，总线被认为是空闲的。总线的空闲状态在第6节中指定。
<br>
如果重复启动条件（Sr）而不是停止条件，总线将保持繁忙。在这方面，开始（S）和重复开始（Sr）条件在功能上是相同的。因此，在本文档的其余部分中，S符号用作一个通用术语来表示开始和重复的启动条件，除非特别指明Sr。

如果设备拥有特殊的硬件设计，启动和停止条件的检测是很容易的。然而，没有这样的微控制器
接口必须在每个时钟周期内至少两次采样SDA线来感知条件的变化。

###3.1.5 字节格式

SDA线上传输的每个字节都必须是8bits。每此传输可以传输的字节数不受限制。每个字节后必须跟一个应答位。数据传输时高位优先(MSB)(参见图6)。如果一个从设备无法接收或在执行完一些其它功能，比如内部中断之前，而不能传输下一个完整的字节的数据,它可以拉低时钟线SCL强迫主机进入等待状态。当从机准备好传输下一个字节的数据并释放时钟线SCL时，数据传输就会继续。

![](leanote://file/getImage?fileId=5b6184826d935e3309000003)

###3.1.6 应答和无应答

应答发生在每个字节之后。应答位允许从机向主机发送应答信号，即该字节已成功接收，另一个字节可被发送。主机产生所有的时钟脉冲，包括应答的第九个时钟脉冲。<br>
应答信号的定义如下：在第九脉冲期间，主机释放SDA线，接收方可以将SDA线拉低，在这个时钟脉冲的高周期内SDA需要保持稳定的低电平（见图4）。持续时间（第6节中指定）也必须考虑在内。<br>
当SDA在第9个时钟脉冲中保持高电平时，这被定义为无应答信号。然后，主机可以生成停止传输的停止条件，或者一个重复的启动条件来启动一个新的传输。有五个可能性导致了一个NACK的产生：
1.在总线上没有相应地址的从机，因此没有设备反馈应答。
2.接收方无法继续接收或传输，因为它可能长在执行的实时的功能，还没有准备好与主机通信
3.本次传输，从机得到的数据或命令无法解析。
4.本次传输，从机不能继续接收数据。
5.主机接收必须通知从机发送的结束

###3.1.7 时钟同步

两个主机可能同时在一条空闲总线上发起传输，则必须有一种方法来决定哪一个主机控制总线并传输信号。这是通过时钟同步和仲裁来完成的。在单主机系统中，不需要时钟同步和仲裁。<br>
时钟同步是通过SCL线的“线-与”逻辑实现的。在SCL线高到低的下降沿主机开始计算低电平持续时间,一旦主机时钟变为低电平,主机将下拉SCL线的电平直到时钟变为高电平(参见图7)。然而如果存在另一个主机，且其时钟仍然处于低电平期间,前一个主机的时钟由低到高的上升沿转变可能不会改变SCL的状态。因此，SCL线被第二个主机的低电平继续拉低。此时第一个主机的时钟进入了一个高电平的等待状态。
![](leanote://file/getImage?fileId=5b62b3aa09ff43629f000000)
当所有的主机都度过了各自时钟的低电平周期，SCL线就会被释放并被外部上拉电阻拉高。主机的时钟状态和和SCL线的状态一致，所有的主机都开始计算它们的高电平周期（度过各自时钟的高电平时间）。第一个完成它的高电平周期的主机再次将SCL线拉低。
通过这种方式，同步后的SCL时钟的低电平持续时间是由最慢的主机的时钟的低电平持续时间决定的，SCL时钟的高电平持续时间是由一个最快的主机的时钟的高电平持续时间决定的。

###3.1.8 仲裁

仲裁就像时钟同步一样，是当系统中存在不止一个主机的情况下才需要的协议的一部分。从机没有参与仲裁程序。只有当总线是空闲的，主机才可以启动传输。两个主机可能在开始条件的最小持有时间（tHD;STA）中产生一个开始条件，从而在总线上产生一个有效的启动条件。所以需要仲裁来确定哪个主机允许传输。

仲裁的过程是按bit进行的。在每一bit上，当SCL高的时候，每个主机都会检查SDA电平是否与它所发送的内容相匹配。这个过程可能需要验证很多bit。两个主机实际上可以在没有错误的情况下完成整个通信，只要通信数据是相同的。某次，一个主机试图发送一个高电平bit，但是检测到SDA是低电平，主机从而知道它已经失去了仲裁并关闭了它的SDA输出。另一个主机继续完成交易。

在仲裁过程中没有丢失任何信息。一个失去仲裁的主机
可以继续生成时钟脉冲直到它失去仲裁的字节的末尾。
当总线空闲时，主机必须重新使用开始条件发起传输。

如果一个主机同事扮演一个从机功能并且在寻址阶段中失去了仲裁，可能是仲裁成功的主机正在尝试寻址此混合设备。
失去仲裁的设备必须立即切换到它的从设备模式。

图8显示了两个主机的仲裁过程。当有更多主机连接到总线时，情况可能更加复杂。当主机生成DATA1的数据电平和SDA线的实际电平之间存在差异时，DATA1输出就会被关闭，这不会影响到仲裁成功的主机发起的数据传输。

![](leanote://file/getImage?fileId=5b62be8c09ff43629f000001)

由于对i2c总线的控制完全由竞争双方发送的地址和数据决定，所以没有中央主机，总线上也没有任何优先级设定。

如果仲裁过程仍在进行中，但其中一个主机发送了重复的开始或停止条件，而另一个主机仍在发送数据时，则存在一个未定义的状态。换句话说，下列组合导致了未定义的状态：

 - 主机1发送一个重复的启动条件，主机2发送一个数据位。
 - 主机1发送一个停止条件，主机2发送一个数据位。
 - 主机1发送一个重复的启动条件，主机2发送一个停止条件。

###3.1.9 时钟展宽 

通过将SCL线保持在低电平，时钟的展宽会暂停通信。
直到这条线再次被释放，通信才会继续。时钟展宽是可选的，事实上，大多数的从设备都不包括SCL的驱动所以他们无法拉伸时钟。
在字节级别上，设备可以以较快的速度接收数据字节，但是需要更多的时间存储接收到的字节或准备用来传输的下一个字节。
一种握手过程（参见图7）：从机可以接收后将SCL线保持在低电平，并确认一个字节来强制主机进入等待状态，直到从机为下一个字节的传输做好准备

在bit级别上，带有或没带有I2C总线硬件限制的设备，如微控制器，可以通过延长每一个时钟周期的低电平来减慢总线的时钟。主机将会适应这个设备的内部操作速度。

在高速模式中，这个握手功能只能在字节级别上使用（参见第5.2节）。

###3.1.10 从机地址和读写bit

数据传输遵循图9所示的格式。在开始条件（S）之后，会发送一个从机地址。这个地址是7位长，后面是第8位，这是一个数据方向位（r/w），“0”表示传输（写），“1”表示对数据的请求（读）（参见图10）。数据传输总是由主机生成的停止条件（P）终止。但是，如果一个主机仍然希望在总线上进行通信，它可以生成一个重复的启动条件（Sr），并在不首先产生停止条件的情况下处理另一个从机。在这样的传输中，可能会有各种读/写格式的组合。

![](leanote://file/getImage?fileId=5b62c56b09ff43629f000002)
![](leanote://file/getImage?fileId=5b62c57609ff43629f000003)

可能的数据传输格式如下：

 - 主机发送，从机接收。传输方向不变(见图11)。从机接收方应答每个字节。
 - 主机从第一个字节后立即读取从设备（参见图12）。在第一次应答的时候，主机发送状态变成了一个主机接收状态，而从机接受状态变成了一个从机发送状态。第一个应答仍然是由从机产生的。主机产生后续的应答。停止条件是由主机产生的，它在停止条件之前发送一个无应答
 - 组合格式（参见图13）。在传输过程中，开始条件和从机地址都是重复的，但是r/w的位被颠倒了。如果主机接收方发送一个重复的启动条件，它会在重复启动条件之前发送一个非应答（A）。
注意：
1. 例如，可以使用组合格式来控制串行内存。内存内部地址必须在第一个数据字节期间写入。在开始条件和从属地址重复之后，数据可以被读出。
2. 自动增加或减少先前访问内存位置的机制，是由设备的设计者定义的。
3. 每个字节后面跟着一个确认位，由序列中的应答或非应答指示。
4. i2c总线兼容设备必须在接收开始或重复启动条件时重置它们的总线逻辑，以便它们都准备接收从机地址，即使这些起始条件没有发生在通讯的适当位置
5。一个开始条件，紧接着是一个停止条件（空消息）是一种非法格式。但是设备在这种情况下也应该正常工作。
6。每个连接到总线的设备都可以通过一个唯一的地址来寻址。
通常总线内部逻辑都是简单的主/从关系，但是有可能有多个相同的从机，可以同时接收和响应，例如在广播组中。
解决方案是使用总线切换设备如PCA9546A,所有四个通道连接同样的设备同时配置。理论上不可能确认每个从机的应答,然后每次打开一个通道读取每个设备的配置并确认。
参考单个组件数据表。
![](leanote://file/getImage?fileId=5b62e76f09ff43629f000004)
![](leanote://file/getImage?fileId=5b62e77a09ff43629f000005)
![](leanote://file/getImage?fileId=5b62e78709ff43629f000006)

###3.1.11 10-bit寻址

10位寻址扩展了可能的地址数量。具有7位和10位地址的设备可以连接到相同的i2c总线，并且在所有总线速度模式中都可以使用7位和10位寻址。目前，10位寻址未被广泛使用。<br>
10位从机地址是在开始条件（S）或重复启动条件（Sr）后的前两个字节中形成的。<br>
第一个字节的前7位是组合1111 0XX，其中最后两个位（XX）是10位地址的两个最重要的位（MSB）;第一个字节的第8位是仍然是决定通信方向的r/w位。
尽管有8种可能的保留地址段，1111 XXX,
但只有4种组合1111 0XX用于10位寻址。
剩下的四个组合1111 1 XX是为将来的i2c总线增强保留的。
前面描述的7位寻址的所有读/写格式的组合都可以使用10位寻址。
详细如下：

 - 主机向一个10位地址的从机发送数据。传输方向没有改变（参见图14）。当一个10位地址跟随一个开始条件时，每个从机用第一个字节（1111 0XX）的前7位与它自己的地址进行比较，如果第8位（r/w方向位）为0的话。
有可能不止一个设备找到匹配并产生一个确认（A1）。
所有匹配的从机都将从机地址的第二个字节（XXXX XXXX）与他们自己的地址进行比较，但是只有一个从机匹配到并生成一个确认（A2）。匹配的从机一直被主机寻址，直到它收到一个停止条件（P）或一个重复的启动条件（Sr）且跟随着一个不同的从机地址。
 - 主机接收是通过一个10位的从机地址来读取从机发送的信息。
第二个r/w位后的传输方向改变（图15）。过程与主机向一个10位地址的从机发送数据描述的相同，包括应答位 A2
在重复启动条件之后（Sr），一个匹配的从机会记住它之前已经被寻址。
这个从机检查重复启动条件后发出的从机地址的第一个字节的前7位是否与开始条件（S）之后相同，并测试第八（r/w）位是1。如果匹配，从机认为它已被寻址并需要发送数据并生成应答A3。从机作为发送方一直被寻址，直到它接收一个停止条件（P）或直到它接收到另一个重复的启动条件（Sr）且跟随着有一个不同的从机地址。
在重复启动条件（Sr）之后，所有其他的从机设备也会比较第一个字节的前7位
从属地址（1111 0XX）和他们自己的地址，并测试第八（r/w）位。
但是，由于r/w=1（对于10位设备），或者是1111 0XX（对于7位设备）的从机地址，其他设备均不匹配。
![](leanote://file/getImage?fileId=5b62f02009ff43629f000007)
![](leanote://file/getImage?fileId=5b62f02b09ff43629f000008)

??带有10位寻址的从机设备与7位寻址的从机设备以相同的方式对“全呼”作出反应??
硬件主机可以在“全呼”之后传送他们的10位地址。在这种情况下，“全呼”地址字节后面跟着两个连续的包含主发送器的10位地址的字节。??
格式如下所示图15中第一个数据字节包含了master的8个最不重要的部分地址。
START字节0000 0001（01h）可以在10位寻址之前，以相同的方式对于7位寻址（参见第3.1.15节）。

###3.1.12 保留地址

##4 I2C通信协议的其他使用

##5 总线速度

##6 电气特性和时序

##7 I2C总线设备到总线的电气连接

##8 缩略语表

##9 法律信息

##10 目录
